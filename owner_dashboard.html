<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù„Ø¹Ø¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Tajawal', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card {
            text-align: center;
            padding: 1.5rem 1rem;
            border-radius: 12px;
            background: linear-gradient(135deg, #198754 0%, #146c43 100%);
            color: white;
            border: none;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .city-header {
            background: linear-gradient(135deg, #198754 0%, #146c43 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .table th {
            background: linear-gradient(135deg, #198754 0%, #146c43 100%);
            color: white;
            border: none;
            padding: 0.8rem 0.6rem;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .table td {
            padding: 0.7rem 0.6rem;
            vertical-align: middle;
            border-color: #f1f3f4;
            font-size: 0.9rem;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-paid { 
            background: #d4edda;
            color: #155724;
        }
        
        .badge-pending { 
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-confirmed { 
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-cancelled { 
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-left: 8px;
            font-size: 0.8rem;
        }
        
        .loading-spinner {
            width: 2rem;
            height: 2rem;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #198754;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .nav-brand {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .revenue-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ù…ØµØºØ± */
        .navbar {
            padding: 0.5rem 0;
            margin-bottom: 1rem;
        }
        
        .navbar-brand {
            color: #000 !important;
            font-weight: 600;
        }
        
        .nav-link {
            color: #000 !important;
            font-weight: 500;
        }
        
        .btn-outline-light {
            border-color: #000;
            color: #000;
        }
        
        .btn-outline-light:hover {
            background-color: #000;
            color: #fff;
        }

        /* ØªØµÙ…ÙŠÙ…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-action {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            margin: 2px;
        }

        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .btn-cancel {
            background: #dc3545;
            color: white;
            border: none;
        }

        .btn-cancel:hover {
            background: #c82333;
            color: white;
        }

        .btn-cancel:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-complete {
            background: #28a745;
            color: white;
            border: none;
        }

        .btn-complete:hover {
            background: #218838;
            color: white;
        }

        .btn-complete:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .hidden-row {
            background-color: #f8f9fa !important;
            opacity: 0.6;
        }

        .hidden-row td {
            color: #6c757d !important;
            text-decoration: line-through;
        }

        .completed-row {
            background-color: #e8f5e8 !important;
        }

        .completed-row td {
            color: #155724 !important;
        }

        .payment-cash {
            border-left: 3px solid #28a745;
        }

        .payment-online {
            border-left: 3px solid #007bff;
        }

        .alert-custom {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            min-width: 300px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInDown 0.5s ease-out;
        }

        @keyframes slideInDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .btn-refresh {
            transition: all 0.3s ease;
        }
        
        .btn-refresh:hover {
            transform: rotate(180deg);
        }

        .actions-column {
            min-width: 120px;
        }
    </style>
</head>
<body>
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ù…ØµØºØ± -->
    <nav class="navbar navbar-light glass-card">
        <div class="container">
            <span class="navbar-brand mb-0 h6">
                <i class="fas fa-chart-line me-2"></i>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </span>
            <div class="navbar-nav ms-auto d-flex align-items-center flex-row">
                <span class="nav-link mx-2" id="ownerWelcome">Ù…Ø±Ø­Ø¨Ø§Ù‹!</span>
                <span class="badge bg-dark me-2" id="cityBadge"></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i> Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© -->
        <div class="city-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-2">
                        <i class="fas fa-city me-2"></i>
                        <span id="cityName">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</span>
                    </h4>
                    <p class="mb-0" id="cityStats">
                        <i class="fas fa-spinner fa-spin me-2"></i>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...
                    </p>
                </div>
                <div class="col-md-4 text-left">
                    <button class="btn btn-light btn-sm btn-refresh" onclick="refreshBookings()" id="refreshBtn">
                        <i class="fas fa-sync-alt me-1"></i> ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="row mb-3">
            <div class="col-md-3 col-6 mb-2">
                <div class="stat-card">
                    <div class="stat-number" id="totalBookings">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-2">
                <div class="stat-card">
                    <div class="stat-number" id="confirmedBookings">0</div>
                    <div class="stat-label">Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¤ÙƒØ¯Ø©</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-2">
                <div class="stat-card">
                    <div class="stat-number" id="completedBookings">0</div>
                    <div class="stat-label">Ù…ÙƒØªÙ…Ù„Ø©</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-2">
                <div class="stat-card revenue-card">
                    <div class="stat-number" id="totalRevenue">0</div>
                    <div class="stat-label">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø¯Ø±Ù‡Ù…)</div>
                </div>
            </div>
        </div>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª -->
        <div class="glass-card">
            <div class="card-header bg-transparent border-0 py-2">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0 text-dark">
                            <i class="fas fa-calendar-check me-2 text-success"></i> Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
                            <small class="text-muted ms-2" id="bookingsCount">(0 Ø­Ø¬Ø²)</small>
                        </h5>
                    </div>
                    <div class="col-md-6 text-left">
                        <div class="d-flex gap-2 justify-content-end">
                            <button class="btn btn-success btn-sm btn-refresh" onclick="refreshBookings()">
                                <i class="fas fa-sync-alt me-1"></i> ØªØ­Ø¯ÙŠØ«
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                    <th>Ø§Ù„Ù…Ù„Ø¹Ø¨</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„Ø¯ÙØ¹</th>
                                    <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th class="actions-column">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="bookingsTable">
                                <tr>
                                    <td colspan="10" class="py-4">
                                        <div class="loading-spinner mb-2"></div>
                                        <p class="text-muted text-center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let ownerData = null;
let allBookings = [];
let currentCancelBookingId = null;
let currentCompleteBookingId = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ...');
    loadOwnerData();
});

function loadOwnerData() {
    const userData = localStorage.getItem('currentUser');
    if (!userData) {
        console.log('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ - Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        window.location.href = 'login.html';
        return;
    }
    
    try {
        ownerData = JSON.parse(userData);
        console.log('âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ:', ownerData);
        
        if (ownerData.role !== 'owner') {
            console.log('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù…Ø§Ù„Ùƒ - Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©');
            window.location.href = 'map.html';
            return;
        }
        
        document.getElementById('ownerWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${ownerData.name}`;
        document.getElementById('cityName').textContent = `Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ${ownerData.city}`;
        document.getElementById('cityBadge').textContent = ownerData.city;
        
        loadRealData();
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        window.location.href = 'login.html';
    }
}

function loadRealData() {
    console.log('ğŸ“Š Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª...');
    document.getElementById('cityStats').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
    const refreshBtn = document.querySelector('.btn-refresh');
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«';

    fetch('php/owner_dashboard.php')
    .then(res => {
        console.log('ğŸ“¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:', res.status, res.statusText);
        return res.json();
    })
    .then(data => {
        console.log('âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª:', data);
        if (data.success) {
            allBookings = data.data;
            displayOwnerBookings(allBookings);
            updateOwnerStats(allBookings);
            
            const paidCount = allBookings.filter(b => b.payment_status === 'paid').length;
            const activeCount = allBookings.filter(b => b.status === 'confirmed').length;
            const completedCount = allBookings.filter(b => b.status === 'completed').length;
            document.getElementById('cityStats').textContent = 
                `${allBookings.length} Ø­Ø¬Ø² â€¢ ${paidCount} Ù…Ø¯ÙÙˆØ¹ â€¢ ${activeCount} Ù†Ø´Ø· â€¢ ${completedCount} Ù…ÙƒØªÙ…Ù„`;
        } else {
            console.error('âŒ Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…:', data.message);
            displayNoData();
        }
    })
    .catch(err => {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err);
        displayNoData();
    })
    .finally(() => {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> ØªØ­Ø¯ÙŠØ«';
    });
}

function displayOwnerBookings(bookings) {
    const tbody = document.getElementById('bookingsTable');
    
    if (bookings.length === 0) {
        displayNoData();
        return;
    }

    // ÙØ±Ø² Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª: Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ù„ØºØ§Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ØŒ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    const sortedBookings = [...bookings].sort((a, b) => {
        if (a.status === 'cancelled' && b.status !== 'cancelled') return 1;
        if (a.status !== 'cancelled' && b.status === 'cancelled') return -1;
        if (a.status === 'completed' && b.status !== 'completed') return -1;
        if (a.status !== 'completed' && b.status === 'completed') return 1;
        return new Date(b.reservation_date) - new Date(a.reservation_date);
    });

    tbody.innerHTML = sortedBookings.map(b => `
        <tr class="${b.status === 'cancelled' ? 'hidden-row' : ''} ${b.status === 'completed' ? 'completed-row' : ''} ${b.payment_method === 'cash' ? 'payment-cash' : 'payment-online'}">
            <td class="fw-bold">#${b.id}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="user-avatar">
                        ${b.user_name ? b.user_name.charAt(0).toUpperCase() : 'U'}
                    </div>
                    <div>
                        <div class="fw-bold">${b.user_name || 'Ù…Ø³ØªØ®Ø¯Ù…'}</div>
                        <small class="text-muted">${b.user_phone || ''}</small>
                    </div>
                </div>
            </td>
            <td class="fw-bold">${b.field_name}</td>
            <td>${formatDate(b.reservation_date)}</td>
            <td>${b.start_time} - ${b.end_time}</td>
            <td class="fw-bold text-success">${b.total_price} Ø¯Ø±Ù‡Ù…</td>
            <td>
                ${b.payment_method === 'online' ? 
                    '<i class="fas fa-credit-card text-primary" title="Ø¯ÙØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"></i>' : 
                    '<i class="fas fa-money-bill-wave text-success" title="Ø¯ÙØ¹ Ù†Ù‚Ø¯ÙŠ"></i>'}
                <small class="d-block text-muted">${b.payment_method === 'online' ? 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' : 'Ù†Ù‚Ø¯ÙŠ'}</small>
            </td>
            <td>
                <span class="status-badge ${getPaymentStatusClass(b.payment_status)}">
                    ${getPaymentStatusText(b.payment_status)}
                </span>
            </td>
            <td>
                <span class="status-badge ${getStatusClass(b.status)}">
                    ${getStatusText(b.status)}
                </span>
            </td>
            <td>
                <div class="d-flex flex-column gap-1">
                    ${b.status !== 'cancelled' && b.status !== 'completed' ? `
                        ${b.payment_method === 'cash' && b.payment_status === 'pending' ? `
                            <button class="btn btn-complete btn-action" onclick="openCompleteModal(${b.id}, '${b.user_name}', '${b.field_name}', '${b.reservation_date}', '${b.start_time}', '${b.end_time}', ${b.total_price})"
                                    title="ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù†Ù‚Ø¯ÙŠ">
                                <i class="fas fa-check-circle me-1"></i>ØªÙ… Ø§Ù„Ø¯ÙØ¹
                            </button>
                        ` : ''}
                        
                        <button class="btn btn-cancel btn-action" onclick="openCancelModal(${b.id}, '${b.user_name}', '${b.field_name}', '${b.reservation_date}', '${b.start_time}', '${b.end_time}')" 
                                ${isPastBooking(b.reservation_date, b.start_time) ? 'disabled' : ''}
                                title="${isPastBooking(b.reservation_date, b.start_time) ? 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ' : 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²'}">
                            <i class="fas fa-times"></i>
                            ${isPastBooking(b.reservation_date, b.start_time) ? 'Ù…Ù†ØªÙ‡ÙŠ' : 'Ø¥Ù„ØºØ§Ø¡'}
                        </button>
                    ` : `
                        <span class="text-muted small text-center">
                            <i class="fas ${b.status === 'completed' ? 'fa-check-circle text-success' : 'fa-ban'} me-1"></i>
                            ${b.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : 'Ù…Ù„ØºÙ‰'}
                        </span>
                    `}
                </div>
            </td>
        </tr>
    `).join('');

    console.log(`âœ… ØªÙ… Ø¹Ø±Ø¶ ${bookings.length} Ø­Ø¬Ø²`);
}

function displayNoData() {
    const tbody = document.getElementById('bookingsTable');
    tbody.innerHTML = `
        <tr>
            <td colspan="10" class="py-4 text-center">
                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø­Ø¬ÙˆØ²Ø§Øª ÙÙŠ Ù…Ø¯ÙŠÙ†Ø© ${ownerData.city} Ø¨Ø¹Ø¯</p>
                <button class="btn btn-success btn-sm mt-2" onclick="window.location.href='map.html'">
                    <i class="fas fa-plus me-1"></i>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨
                </button>
            </td>
        </tr>`;
    
    document.getElementById('cityStats').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª';
    updateOwnerStats([]);
}

function updateOwnerStats(bookings) {
    const totalBookings = bookings.length;
    const confirmedBookings = bookings.filter(b => b.status === 'confirmed').length;
    const completedBookings = bookings.filter(b => b.status === 'completed').length;
    const totalRevenue = bookings
        .filter(b => b.payment_status === 'paid' || b.status === 'completed')
        .reduce((sum, b) => sum + parseFloat(b.total_price || 0), 0);

    document.getElementById('totalBookings').textContent = totalBookings;
    document.getElementById('confirmedBookings').textContent = confirmedBookings;
    document.getElementById('completedBookings').textContent = completedBookings;
    document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(0);
    
    document.getElementById('bookingsCount').textContent = `(${totalBookings} Ø­Ø¬Ø²)`;

    console.log(`ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ${totalBookings} Ø¥Ø¬Ù…Ø§Ù„ÙŠ, ${confirmedBookings} Ù…Ø¤ÙƒØ¯, ${completedBookings} Ù…ÙƒØªÙ…Ù„, ${totalRevenue} Ø¥ÙŠØ±Ø§Ø¯Ø§Øª`);
}

function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-EG', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®:', error);
        return dateString;
    }
}

function getPaymentStatusClass(status) {
    const classes = { 
        paid: 'badge-paid', 
        pending: 'badge-pending',
        failed: 'badge-cancelled'
    };
    return classes[status] || 'badge-pending';
}

function getPaymentStatusText(status) {
    const texts = { 
        paid: 'Ù…Ø¯ÙÙˆØ¹', 
        pending: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹',
        failed: 'ÙØ§Ø´Ù„'
    };
    return texts[status] || status;
}

function getStatusClass(status) {
    const classes = { 
        pending: 'badge-pending', 
        confirmed: 'badge-confirmed', 
        completed: 'badge-completed', 
        cancelled: 'badge-cancelled' 
    };
    return classes[status] || 'badge-pending';
}

function getStatusText(status) {
    const texts = { 
        pending: 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 
        confirmed: 'Ù…Ø¤ÙƒØ¯', 
        completed: 'Ù…ÙƒØªÙ…Ù„', 
        cancelled: 'Ù…Ù„ØºÙ‰' 
    };
    return texts[status] || status;
}

function isPastBooking(date, time) {
    try {
        const bookingDateTime = new Date(`${date}T${time}`);
        const now = new Date();
        return bookingDateTime < now;
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆÙ‚Øª Ø§Ù„Ø­Ø¬Ø²:', error);
        return false;
    }
}

function openCompleteModal(bookingId, userName, fieldName, date, startTime, endTime, totalPrice) {
    currentCompleteBookingId = bookingId;
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø®Ø§ØµØ©
    userName = userName.replace(/'/g, "\\'");
    fieldName = fieldName.replace(/'/g, "\\'");
    
    const modalContent = `
        <div class="modal-header">
            <h5 class="modal-title text-success">
                <i class="fas fa-check-circle me-2"></i>ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="alert alert-success">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„
            </div>
            
            <div class="booking-info p-3 border rounded">
                <h6>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¬Ø²:</h6>
                <p><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${userName}</p>
                <p><strong>Ø§Ù„Ù…Ù„Ø¹Ø¨:</strong> ${fieldName}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${formatDate(date)}</p>
                <p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${startTime} - ${endTime}</p>
                <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…:</strong> <span class="fw-bold text-success">${totalPrice} Ø¯Ø±Ù‡Ù…</span></p>
                <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²:</strong> #${bookingId}</p>
            </div>
            
            <div class="mt-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmPayment">
                    <label class="form-check-label" for="confirmPayment">
                        Ø£Ø¤ÙƒØ¯ Ø£Ù†Ù†ÙŠ Ø§Ø³ØªÙ„Ù…Øª Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ØªØ±Ø§Ø¬Ø¹</button>
            <button type="button" class="btn btn-success" id="confirmCompleteBtn" onclick="confirmCompleteBooking()" disabled>
                <i class="fas fa-check me-1"></i>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
            </button>
        </div>
    `;
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    let modal = document.getElementById('completeBookingModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'completeBookingModal';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    ${modalContent}
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ù„ØªØ£ÙƒÙŠØ¯
        modal.addEventListener('shown.bs.modal', function() {
            const confirmCheckbox = document.getElementById('confirmPayment');
            const confirmBtn = document.getElementById('confirmCompleteBtn');
            
            confirmCheckbox.addEventListener('change', function() {
                confirmBtn.disabled = !this.checked;
            });
        });
    } else {
        modal.querySelector('.modal-content').innerHTML = modalContent;
    }
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    console.log(`ğŸ’° ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø­Ø¬Ø² #${bookingId}`);
}

function openCancelModal(bookingId, userName, fieldName, date, startTime, endTime) {
    currentCancelBookingId = bookingId;
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø®Ø§ØµØ©
    userName = userName.replace(/'/g, "\\'");
    fieldName = fieldName.replace(/'/g, "\\'");
    
    const modalContent = `
        <div class="modal-header">
            <h5 class="modal-title text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>ØªØ£ÙƒÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning">
                <i class="fas fa-info-circle me-2"></i>
                <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡
            </div>
            
            <div class="booking-info p-3 border rounded">
                <h6>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¬Ø²:</h6>
                <p><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${userName}</p>
                <p><strong>Ø§Ù„Ù…Ù„Ø¹Ø¨:</strong> ${fieldName}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${formatDate(date)}</p>
                <p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${startTime} - ${endTime}</p>
                <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²:</strong> #${bookingId}</p>
            </div>
            
            <div class="mt-3">
                <label for="cancelReason" class="form-label">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <textarea class="form-control" id="cancelReason" rows="2" placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¥Ø°Ø§ Ø±ØºØ¨Øª..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ØªØ±Ø§Ø¬Ø¹</button>
            <button type="button" class="btn btn-danger" onclick="confirmCancelBooking()">
                <i class="fas fa-check me-1"></i>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
            </button>
        </div>
    `;
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    let modal = document.getElementById('cancelBookingModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'cancelBookingModal';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    ${modalContent}
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    } else {
        modal.querySelector('.modal-content').innerHTML = modalContent;
    }
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    console.log(`ğŸ“ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² #${bookingId}`);
}

async function confirmCompleteBooking() {
    if (!currentCompleteBookingId) {
        showAlert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø­Ø¬Ø² Ù„Ù„ØªØ£ÙƒÙŠØ¯', 'error');
        return;
    }
    
    try {
        console.log(`ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø­Ø¬Ø² #${currentCompleteBookingId}`);
        
        const formData = new FormData();
        formData.append('action', 'complete_booking');
        formData.append('booking_id', currentCompleteBookingId);

        const response = await fetch('php/owner_dashboard.php', {
            method: 'POST',
            body: formData
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('âŒ Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø±Ø¬Ø¹ HTML Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† JSON:', text.substring(0, 500));
            throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… - ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù PHP ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        }

        const data = await response.json();

        if (data.success) {
            showAlert('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            console.log(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø­Ø¬Ø² #${currentCompleteBookingId} Ø¨Ù†Ø¬Ø§Ø­`);
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            const modal = bootstrap.Modal.getInstance(document.getElementById('completeBookingModal'));
            if (modal) {
                modal.hide();
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
            setTimeout(() => {
                refreshBookings();
            }, 1000);
        } else {
            throw new Error(data.message || 'ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹');
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹:', error);
        showAlert('ÙØ´Ù„ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¯ÙØ¹: ' + error.message, 'error');
    }
}

async function confirmCancelBooking() {
    if (!currentCancelBookingId) {
        showAlert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø­Ø¬Ø² Ù„Ù„Ø¥Ù„ØºØ§Ø¡', 'error');
        return;
    }
    
    const reason = document.getElementById('cancelReason')?.value || '';
    
    try {
        console.log(`ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² #${currentCancelBookingId}`);
        
        const formData = new FormData();
        formData.append('action', 'cancel_booking');
        formData.append('booking_id', currentCancelBookingId);
        formData.append('reason', reason);

        const response = await fetch('php/owner_dashboard.php', {
            method: 'POST',
            body: formData
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('âŒ Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø±Ø¬Ø¹ HTML Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† JSON:', text.substring(0, 500));
            throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… - ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù PHP ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        }

        const data = await response.json();

        if (data.success) {
            showAlert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­', 'success');
            console.log(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² #${currentCancelBookingId} Ø¨Ù†Ø¬Ø§Ø­`);
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            const modal = bootstrap.Modal.getInstance(document.getElementById('cancelBookingModal'));
            if (modal) {
                modal.hide();
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
            setTimeout(() => {
                refreshBookings();
            }, 1000);
        } else {
            throw new Error(data.message || 'ÙØ´Ù„ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²');
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²:', error);
        showAlert('ÙØ´Ù„ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²: ' + error.message, 'error');
    }
}

function showAlert(message, type = 'info') {
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
    const existingAlerts = document.querySelectorAll('.alert-custom');
    existingAlerts.forEach(alert => alert.remove());

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert-custom alert alert-${type} alert-dismissible fade show`;
    
    const icon = {
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-triangle',
        'warning': 'fa-exclamation-circle',
        'info': 'fa-info-circle'
    }[type];
    
    alertDiv.innerHTML = `
        <i class="fas ${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

function refreshBookings() {
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    loadRealData();
}

function logout() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        console.log('ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...');
        localStorage.removeItem('currentUser');
        window.location.href = 'login.html';
    }
}

// ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†
setInterval(() => {
    if (document.visibilityState === 'visible') {
        console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        refreshBookings();
    }
}, 120000);

// Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¬Ø§Ù‡Ø²Ø©');
});
</script>
</body>
</html>